# 現状仕様と使い方

スプレッドシートの「通知設定」シート1行を1通知として処理します。列構成と判定ルールは以下の通りです（現在メール通知は廃止）。

## 列定義（0-based）
- 0: 年（または「指定なし」）
- 1: 月（または「指定なし」）
- 2: 日（または「指定なし」）
- 3: 時刻（必須・日付型の時刻データ）
- 4-10: 曜日（7列・true/false）
- 11: 土日祝を許可（true なら土日祝も送信、false ならスキップ）
  - 12: Slackチャンネル（必須・`#`なしでも送信時に付与。ID形式 `C…` ならそのまま。シート表示形式で自動付与はしていないので、入力はそのままでOK）
- 13: 宛先（任意・`here`/`channel`/ユーザー名またはIDのカンマ区切り）
- 14: 通知内容（必須）
- 15: 登録者（任意）

## Webhook設定と管理者メール
- Script Properties の `SLACK_WEBHOOK_URL` を使用（単一ワークスペース前提）。
- Slack送信者名: `SLACK_USERNAME`（必須）
- Slackアイコン: `SLACK_ICON_EMOJI`（必須、例: `:bell:` のような絵文字名）
- 管理者メール: `BOT_MASTER`（Script Properties）。エラー通知を送るかは `ERROR_MAIL_ENABLED`（true/false）。
- デバッグ日時: `DEBUG_DATE`（任意。未設定なら現在時刻）。
- 通知シート名: `NOTIFICATION_SHEETS`（カンマ区切り複数可。未設定/空はエラーで停止）。
- 期限切れ通知: `EXPIRED_REPORT_ENABLED`（true/false、デフォルトfalse）、通知先 `EXPIRED_REPORT_CHANNEL`（任意。未設定時は管理者メールへ送信、BOT_MASTER がなければログのみ）

## 処理の流れ
- スクリプトロックを取得して単一実行。シートを全行走査。
- Slackチャンネル/通知内容が空ならスキップ。チャンネルは `#` がなければ付与して送信、ID形式 `C…` はそのまま。
- 時刻が日付型でない場合、年/月/日が非数値（「指定なし」以外）ならスキップ。
- 年月日がすべて埋まっている行は「当日でない」場合に早期スキップ。
- 祝日判定は Google 祝日カレンダーをキャッシュし、行の「土日祝を許可」が false の場合は土日祝をスキップ（true なら土日祝でも送信）。
- 複数シート指定の場合、指定されたシートをすべて順に処理。指定シートが存在しない場合はエラーで停止。
- 年月日がすべて指定されていて当日でない行は「期限切れ」としてスキップし、EXPIRED_REPORT_ENABLED=true の場合のみまとめて通知（内容はシート名・行番号・指定日付/時刻・登録者）。

## 通知判定のモード
- 日が「指定なし」なら曜日モード: 曜日7列の当日が true かつ時刻一致で送信。年/月に値を入れるとその年/月にしか送られないので注意。
- 日が指定されていれば日付モード: 曜日列は無視し、指定日＋時刻が一致すれば送信。
  - 年/月/日すべて指定: 当日一致の一度きり。
  - 年なし・月なし・日あり: 年/月は現在値で補完されるため「毎月その日」に送信。
  - 年なし・月あり・日あり: 現在の年で補完されるため「毎年その月その日」に送信。
  - 年あり・月なし・日あり: 月が現在値で補完されるため「毎月その日」で年の指定は実質効かない。

## 送信とエラー
- Slack送信失敗はログに残し、`ERROR_MAIL_ENABLED` が true の場合のみ管理者メール (`BOT_MASTER`) を送る。
- 宛先は here/channel を `<!here>` 等に変換し、カンマ区切りの各要素をそのまま扱う（`<@ID>` 形式または `U…`/`W…` で始まるIDは `<@id>` に、その他は先頭に `@` を付ける。※名前は @ なしで入力する。シート表示形式で自動付与はしていない）。
- 送信失敗時、登録者列が空でなければ登録者宛にDMを試行する（ユーザー名/IDどちらでも可。失敗時はログに記録）。

## 運用上の注意
- 日付モードと曜日モードが列入力で切り替わるため、年/月を曜日モードで埋めると通知されないケースがある。週次運用では年/月を空（「指定なし」）にする。
- 土日祝を送るかどうかは11列目のチェックで制御（false で土日祝をスキップ）。
- 時刻列は日付型で入力する（文字列や空はスキップされる）。
